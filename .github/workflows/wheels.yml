name: CI (wheels and sdist)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  sdist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4

      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install system dependencies
        run: sudo apt-get install --yes libopenblas-dev libfftw3-dev

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: build sdist
        run: python setup.py sdist

      - name: upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: sdist
          path: "dist/*.tar.gz"
          if-no-files-found: error

      # - name: Publish to PyPI
      #   if: startsWith(github.ref, 'refs/tags/')
      #   env:
      #     TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
      #     TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      #   run: |
      #     pip install twine
      #     twine upload --skip-existing dist/*.tar.gz

  wheel:
    runs-on: ${{ matrix.os }}

    env:
      MACOSX_DEPLOYMENT_TARGET: "10.9"
      CIBW_BUILD_VERBOSITY: "1"
      CIBW_BEFORE_ALL_MACOS: "brew install fftw openblas"
      CIBW_BEFORE_ALL_LINUX: "yum -y install openblas-devel fftw-devel"

      CIBW_BUILD: "${{ matrix.cibw.build || '*' }}"
      CIBW_MANYLINUX_X86_64_IMAGE: "${{ matrix.cibw.manylinux_image }}"
      CIBW_MANYLINUX_I686_IMAGE: "${{ matrix.cibw.manylinux_image }}"
      # CIBW_MANYLINUX_AARCH64_IMAGE: "${{ matrix.cibw.manylinux_image }}"
      CIBW_ARCHS_LINUX: "${{ matrix.cibw.arch || 'auto' }}"
      CIBW_ARCHS_MACOS: "${{ matrix.cibw.arch || 'auto' }}"
      # CIBW_BEFORE_TEST: pip install {package} -r requirements-dev.txt
      # CIBW_TEST_REQUIRES: "pytest"
      # CIBW_TEST_COMMAND: pytest {package}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            name: mac
            cibw:
            build: "cp3*"

          # - os: macos-latest
          #   name: mac-arm
          #   cibw:
          #     arch: universal2
          #     build: "cp39*"

          # - os: ubuntu-latest
          #   name: manylinux1
          #   cibw:
          #     build: "cp36* cp37*"
          #     manylinux_image: manylinux1

          - os: ubuntu-latest
            name: manylinux2010
            cibw:
              # build: "cp38* cp39* pp3*"
              manylinux_image: manylinux2010

          # - os: ubuntu-latest
          #   name: cp36-manylinux_aarch64
          #   cibw:
          #     build: "cp3*"
          #     manylinux_image: manylinux2014
          #     arch: aarch64

          # - os: windows-latest
          #   name: win32
          #   architecture: x86
          #   cibw:
          #     build: "cp*win32"

          # - os: windows-2016
          #   name: win32-pypy
          #   architecture: x86
          #   cibw:
          #     build: "pp*win32"

          # - os: windows-latest
          #   name: win_amd64
          #   architecture: x64
          #   cibw:
          #     build: "*win_amd64"

        # os: ["ubuntu-latest"]
        # python-version: [3.6, 3.7, 3.8, 3.9]

    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
          architecture: ${{ matrix.architecture }}

      - name: customize mac-arm-64
        if: contains(matrix.os, 'macos') && matrix.cibw.arch
        run: |
          sudo xcode-select -switch /Applications/Xcode_12.2.app
          echo 'SDKROOT=/Applications/Xcode_12.2.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk' >> "$GITHUB_ENV"
          echo 'MACOSX_DEPLOYMENT_TARGET=10.15' >> "$GITHUB_ENV"

      - name: Install mac-os Dependencies
        if: startsWith(matrix.os, 'mac')
        run: |
          python -m pip install delocate
          brew install openblas fftw

      - name: Install linux Dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          python -m pip install auditwheel
          sudo apt-get install --yes libopenblas-dev libfftw3-dev

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade setuptools pip wheel cython
          python -m pip install cibuildwheel

      - name: show environment
        run: |
          pip freeze

      - name: list target wheels
        run: |
          python -m cibuildwheel . --print-build-identifiers

      # - name: compile Cython sources
      #   run: |
      #     python setup.py cython

      - name: Build wheels
        run: |
          python -m cibuildwheel .

      - uses: actions/upload-artifact@v2
        with:
          name: wheels-${{ matrix.name }}
          path: "wheelhouse/*"
          if-no-files-found: error

      # - name: customize aarch64
      #   if: contains(matrix.cibw.arch, 'aarch64')
      #   # install zeromq-devel because building libzmq for arm takes too long
      #   # it's not in default packages, but it is in epel-7
      #   # this will be an older release than than other wheels
      #   run: |
      #     echo '${{ matrix.cibw.arch }}'
      #     echo 'CIBW_BEFORE_ALL_LINUX=yum -y install openblas-devel fftw-devel' >> "$GITHUB_ENV"

  # build_macos_wheels:
  #   name: Build wheels on ${{ matrix.os }}
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       os: [macos-latest]

  #   steps:
  #     - uses: actions/checkout@v2
  #       with:
  #         fetch-depth: 0

  #     - uses: actions/setup-python@v2
  #       name: Install Python
  #       with:
  #         python-version: 3.7

  #     - name: Install cibuildwheel
  #       run: |
  #         python -m pip install cibuildwheel
  #     - name: Build wheels for CPython 3.9 and Mac OS
  #       run: |
  #         brew install openblas fftw
  #         python -m cibuildwheel --output-dir dist
  #       env:
  #         CIBW_BUILD: "cp39-*"
  #         CIBW_MANYLINUX_X86_64_IMAGE: manylinux1
  #         CIBW_MANYLINUX_I686_IMAGE: manylinux1
  #         # CIBW_BEFORE_BUILD: pip install certifi numpy==1.19.3
  #         CC: /usr/bin/clang
  #         CXX: /usr/bin/clang++

  #     - name: Build wheels for CPython (MacOS)
  #       if: matrix.os == 'macos-latest'
  #       run: |
  #         brew install openblas fftw
  #         python -m cibuildwheel --output-dir dist
  #       env:
  #         CIBW_BUILD: "cp3?-*"
  #         CIBW_SKIP: "cp35-* cp36-* cp39-*"
  #         CIBW_MANYLINUX_X86_64_IMAGE: manylinux1
  #         CIBW_MANYLINUX_I686_IMAGE: manylinux1
  #         # CIBW_BEFORE_BUILD: pip install certifi numpy==1.16
  #         CC: /usr/bin/clang
  #         CXX: /usr/bin/clang++

  #     # - name: Build wheels for CPython 3.6
  #     #   run: |
  #     #     python -m cibuildwheel --output-dir dist
  #     #   env:
  #     #     CIBW_BUILD: "cp36-*"
  #     #     CIBW_MANYLINUX_X86_64_IMAGE: manylinux1
  #     #     CIBW_MANYLINUX_I686_IMAGE: manylinux1
  #     #     CIBW_BUILD_VERBOSITY: 2
  #     #     # CIBW_BEFORE_BUILD: pip install certifi numpy==1.16
  #     #   if: >
  #     #     startsWith(github.ref, 'refs/heads/v0.17') ||
  #     #     startsWith(github.ref, 'refs/tags/v0.17')
  #     - uses: actions/upload-artifact@v2
  #       with:
  #         name: wheels
  #         path: ./dist/*.whl
